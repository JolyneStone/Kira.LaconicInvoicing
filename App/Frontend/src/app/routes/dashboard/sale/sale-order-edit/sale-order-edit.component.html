<page-header title="{{ 'app.dashboard.saleorder-management' | translate }}"></page-header>
<form nz-form #f="ngForm" se-container="1" [nzLayout]="'vertical'">
  <nz-card [nzBordered]="false" nzTitle="{{ 'app.dashboard.saleorder-base-info' | translate }}">
    <nz-row nzGutter="16">
      <nz-col nzLg="6" nzMd="12" nzSm="24">
        <se label="{{ 'app.dashboard.saleorder-number' | translate }}">
          <nz-input-group [nzAddOnAfter]="addOnAfterNumberTemplate">
            <input nz-input #number="ngModel" name="number" required [(ngModel)]="saleOrderDto.number"
              placeholder="{{ 'app.dashboard.saleorder-please-number' | translate}}" />
          </nz-input-group>
          <nz-form-explain *ngIf="(number.dirty || number.touched) && number.errors?.required">
            {{ 'app.dashboard.saleorder-please-number' | translate }}
          </nz-form-explain>
          <ng-template #addOnAfterNumberTemplate>
            <button nz-button nzType="primary" (click)="getNewNumber()" [disabled]="!auth.GetNewNumber && mode!=='Add'"
              nzSize="small" nzGhost>{{ 'app.get' | translate }}</button>
          </ng-template>
        </se>
      </nz-col>
      <nz-col [nzXl]="{span:6, offset:2}" [nzLg]="{span:8}" [nzMd]="{span:12}" nzSm="24">
        <se label="{{ 'app.dashboard.saleorder-pay-way' | translate }}">
          <nz-select [(ngModel)]="saleOrderDto.payWay" name="payWay" required #payWay="ngModel"
            nzPlaceHolder="{{ 'app.dashboard.saleorder-please-pay-way' | translate }}">
            <nz-option *ngFor="let p of payWays" [nzLabel]="p.name" [nzValue]="p.name">
            </nz-option>
          </nz-select>
          <nz-form-explain *ngIf="(payWay.dirty || payWay.touched) && payWay.errors?.required">
            {{ 'app.dashboard.saleorder-please-pay-way' | translate }}</nz-form-explain>
        </se>
      </nz-col>
      <nz-col [nzXl]="{span:6, offset:2}" [nzLg]="{span:8}" [nzMd]="{span:12}" nzSm="24">
        <se label="{{ 'app.dashboard.saleorder-freight' | translate }}">
          <input nz-input #freight="ngModel" name="freight" [(ngModel)]="saleOrderDto.freight"
            placeholder="{{ 'app.dashboard.saleorder-please-freight' | translate}}" />
          <nz-form-explain *ngIf="(freight.dirty || freight.touched) && freight.errors?.required">
            {{ 'app.dashboard.saleorder-please-freight' | translate }}
          </nz-form-explain>
        </se>
      </nz-col>
    </nz-row>
    <nz-row nzGutter="16">
      <nz-col nzLg="6" nzMd="12" nzSm="24">
        <se label="{{ 'app.dashboard.saleorder-customer-number' | translate }}">
          <nz-input-group [nzAddOnAfter]="addOnAfterCustomerNumberTemplate">
            <input nz-input #customerNumber="ngModel" name="customerNumber" [(ngModel)]="saleOrderDto.customerNumber"
              placeholder="{{ 'app.dashboard.saleorder-please-customer-number' | translate}}" />
          </nz-input-group>
          <nz-form-explain *ngIf="(customerNumber.dirty || customerNumber.touched) && customerNumber.errors?.required">
            {{ 'app.dashboard.saleorder-please-customer-number' | translate }}
          </nz-form-explain>
          <ng-template #addOnAfterCustomerNumberTemplate>
            <button nz-button nzType="primary" (click)="selectCustomer()" [disabled]="mode!=='Add'" nzSize="small"
              nzGhost>{{ 'app.select' | translate }}</button>
          </ng-template>
        </se>
      </nz-col>
      <nz-col [nzXl]="{span:6, offset:2}" [nzLg]="{span:8}" [nzMd]="{span:12}" nzSm="24">
        <se label="{{ 'app.dashboard.saleorder-customer-name' | translate }}">
          <input nz-input #customerName="ngModel" name="customerName" [(ngModel)]="saleOrderDto.customerName"
            placeholder="{{ 'app.dashboard.saleorder-please-customer-name' | translate}}" />
          <nz-form-explain *ngIf="(customerName.dirty || customerName.touched) && customerName.errors?.required">
            {{ 'app.dashboard.saleorder-please-customer-name' | translate }}
          </nz-form-explain>
        </se>
      </nz-col>
      <nz-col [nzXl]="{span:6, offset:2}" [nzLg]="{span:8}" [nzMd]="{span:12}" nzSm="24">
        <se label="{{ 'app.dashboard.saleorder-consignor' | translate }}">
          <input nz-input #consignor="ngModel" name="consignor" [(ngModel)]="saleOrderDto.consignor"
            placeholder="{{ 'app.dashboard.saleorder-please-consignor' | translate}}" />
          <nz-form-explain *ngIf="(consignor.dirty || consignor.touched) && consignor.errors?.required">
            {{ 'app.dashboard.saleorder-please-consignor' | translate }}
          </nz-form-explain>
        </se>
      </nz-col>
    </nz-row>
    <nz-row nzGutter="16">
      <nz-col nzLg="6" nzMd="12" nzSm="24">
        <se label="{{ 'app.dashboard.saleorder-consignor-contact' | translate }}">
          <input nz-input #consignorContact="ngModel" name="consignorContact"
            [(ngModel)]="saleOrderDto.consignorContact"
            placeholder="{{ 'app.dashboard.saleorder-please-consignor-contact' | translate}}" />
          <nz-form-explain
            *ngIf="(consignorContact.dirty || consignorContact.touched) && consignorContact.errors?.required">
            {{ 'app.dashboard.saleorder-please-consignor-contact' | translate }}
          </nz-form-explain>
        </se>
      </nz-col>
      <nz-col [nzXl]="{span:6, offset:2}" [nzLg]="{span:8}" [nzMd]="{span:12}" nzSm="24">
        <se label="{{ 'app.dashboard.saleorder-warehouse-number' | translate }}">
          <nz-input-group [nzAddOnAfter]="addOnAfterWarehouseNumberTemplate">
            <input nz-input #warehouseNumber="ngModel" name="warehouseNumber" [(ngModel)]="saleOrderDto.warehouseNumber"
              placeholder="{{ 'app.dashboard.saleorder-please-warehouse-number' | translate}}" />
          </nz-input-group>
          <nz-form-explain
            *ngIf="(warehouseNumber.dirty || warehouseNumber.touched) && warehouseNumber.errors?.required">
            {{ 'app.dashboard.saleorder-please-warehouse-number' | translate }}
          </nz-form-explain>
          <ng-template #addOnAfterWarehouseNumberTemplate>
            <button nz-button nzType="primary" (click)="selectWarehouse()" [disabled]="mode!=='Add'" nzSize="small"
              nzGhost>{{ 'app.select' | translate }}</button>
          </ng-template>
        </se>
      </nz-col>
      <nz-col [nzXl]="{span:6, offset:2}" [nzLg]="{span:8}" [nzMd]="{span:12}" nzSm="24">
        <se label="{{ 'app.dashboard.saleorder-warehouse-name' | translate }}">
          <input nz-input #warehouseName="ngModel" name="warehouseName" [(ngModel)]="saleOrderDto.warehouseName"
            placeholder="{{ 'app.dashboard.saleorder-please-warehouse-name' | translate}}" />
          <nz-form-explain *ngIf="(warehouseName.dirty || warehouseName.touched) && warehouseName.errors?.required">
            {{ 'app.dashboard.saleorder-please-warehouse-name' | translate }}
          </nz-form-explain>
        </se>
      </nz-col>
    </nz-row>
    <nz-row nzGutter="16">
      <nz-col nzLg="6" nzMd="12" nzSm="24">
        <se label="{{ 'app.dashboard.saleorder-consignee' | translate }}">
          <input nz-input #consignee="ngModel" name="consignee" [(ngModel)]="saleOrderDto.consignee"
            placeholder="{{ 'app.dashboard.saleorder-please-consignee' | translate}}" />
          <nz-form-explain *ngIf="(consignee.dirty || consignee.touched) && consignee.errors?.required">
            {{ 'app.dashboard.saleorder-please-consignee' | translate }}
          </nz-form-explain>
        </se>
      </nz-col>
      <nz-col [nzXl]="{span:6, offset:2}" [nzLg]="{span:8}" [nzMd]="{span:12}" nzSm="24">
        <se label="{{ 'app.dashboard.saleorder-consignee-contact' | translate }}">
          <input nz-input #consigneeContact="ngModel" name="consigneeContact"
            [(ngModel)]="saleOrderDto.consigneeContact"
            placeholder="{{ 'app.dashboard.saleorder-please-consignee-contact' | translate}}" />
          <nz-form-explain
            *ngIf="(consigneeContact.dirty || consigneeContact.touched) && consigneeContact.errors?.required">
            {{ 'app.dashboard.saleorder-please-consignee-contact' | translate }}
          </nz-form-explain>
        </se>
      </nz-col>
      <nz-col [nzXl]="{span:6, offset:2}" [nzLg]="{span:8}" [nzMd]="{span:12}" nzSm="24">
        <se label="{{ 'app.dashboard.saleorder-source-address' | translate }}">
          <input nz-input #sourceAddress="ngModel" name="sourceAddress" [(ngModel)]="saleOrderDto.sourceAddress"
            placeholder="{{ 'app.dashboard.saleorder-please-source-address' | translate}}" />
          <nz-form-explain *ngIf="(sourceAddress.dirty || sourceAddress.touched) && sourceAddress.errors?.required">
            {{ 'app.dashboard.saleorder-please-source-address' | translate }}
          </nz-form-explain>
        </se>
      </nz-col>
    </nz-row>
    <nz-row nzGutter="16">
      <nz-col nzLg="6" nzMd="12" nzSm="24">
        <se label="{{ 'app.dashboard.saleorder-dest-address' | translate }}">
          <input nz-input #destAddress="ngModel" name="destAddress" [(ngModel)]="saleOrderDto.destAddress"
            placeholder="{{ 'app.dashboard.saleorder-please-source-address' | translate}}" />
          <nz-form-explain *ngIf="(destAddress.dirty || destAddress.touched) && destAddress.errors?.required">
            {{ 'app.dashboard.saleorder-please-dest-address' | translate }}
          </nz-form-explain>
        </se>
      </nz-col>
      <nz-col [nzXl]="{span:6, offset:2}" [nzLg]="{span:8}" [nzMd]="{span:12}" nzSm="24">
        <se label="{{ 'app.dashboard.saleorder-total-amount' | translate }}">
          <input nz-input readonly="readonly" name="totalAmount" [ngModel]="totalAmount" />
        </se>
      </nz-col>
      <nz-col [nzXl]="{span:6, offset:2}" [nzLg]="{span:8}" [nzMd]="{span:12}" nzSm="24">
        <se label="{{ 'app.dashboard.saleorder-amount-paid' | translate }}">
          <input nz-input #amountPaid="ngModel" name="amountPaid" required [(ngModel)]="saleOrderDto.amountPaid"
            placeholder="{{ 'app.dashboard.saleorder-please-amount-paid' | translate}}" />
          <nz-form-explain *ngIf="(amountPaid.dirty || amountPaid.touched) && amountPaid.errors?.required">
            {{ 'app.dashboard.saleorder-please-amount-paid' | translate }}
          </nz-form-explain>
        </se>
      </nz-col>
    </nz-row>
    <nz-row nzGutter="16">
      <nz-col nzLg="6" nzMd="12" nzSm="24">
        <se label="{{ 'app.dashboard.saleorder-status' | translate }}">
          <nz-select [(ngModel)]="saleOrderDto.status" name="status" required #status="ngModel"
            nzPlaceHolder="{{ 'app.dashboard.saleorder-please-status' | translate }}">
            <nz-option *ngFor="let s of statusKeys"
              nzLabel="{{ 'app.dashboard.saleorder-status-' + saleOrderStatus[s] | translate }}" [nzValue]="s">
            </nz-option>
            <!-- <nz-option nzLabel="{{ 'app.dashboard.saleorder-status-book' | translate }}"
              nzValue="SaleOrderStatus.Book"></nz-option>
            <nz-option nzLabel="{{ 'app.dashboard.saleorder-status-order' | translate }}"
              nzValue="SaleOrderStatus.Order"></nz-option>
            <nz-option nzLabel="{{ 'app.dashboard.saleorder-status-transporting' | translate }}"
              nzValue="SaleOrderStatus.Transporting"></nz-option>
            <nz-option nzLabel="{{ 'app.dashboard.saleorder-status-receipt' | translate }}"
              nzValue="SaleOrderStatus.Receipt"></nz-option>
            <nz-option nzLabel="{{ 'app.dashboard.saleorder-status-complete' | translate }}"
              nzValue="SaleOrderStatus.Complete"></nz-option> -->
          </nz-select>
          <nz-form-explain *ngIf="(status.dirty || status.touched) && status.errors?.required">
            {{ 'app.dashboard.saleorder-please-dest-address' | translate }}
          </nz-form-explain>
        </se>
      </nz-col>
      <nz-col [nzXl]="{span:6, offset:2}" [nzLg]="{span:8}" [nzMd]="{span:12}" nzSm="24">
        <se label="{{ 'app.dashboard.saleorder-operator' | translate }}">
          <input nz-input name="operator" [ngModel]="saleOrderDto.operator" />
        </se>
      </nz-col>
    </nz-row>
    <nz-row nzGutter="16">
      <nz-col [nzXl]="{span:24, offset:0}" [nzLg]="{span:24}" [nzMd]="{span:24}" nzSm="24">
        <se label="{{ 'app.dashboard.saleorder-comment' | translate }}">
          <textarea nz-input [(ngModel)]="saleOrderDto.comment" name="comment"
            [nzAutosize]="{ minRows: 4, maxRows: 10 }"
            placeholder="{{ 'app.dashboard.saleorder-please-comment' | translate }}"></textarea>
        </se>
      </nz-col>
    </nz-row>
  </nz-card>
  <nz-card [nzBordered]="false" nzTitle="{{ 'app.dashboard.saleorder-item-info' | translate }}">
    <nz-table [nzData]="saleOrderDto.items" [nzShowPagination]="false">
      <thead>
        <tr>
          <th>{{ 'app.dashboard.saleorder-item-number' | translate }}</th>
          <th>{{ 'app.dashboard.saleorder-item-name'| translate }}</th>
          <th>{{ 'app.dashboard.saleorder-item-price'| translate }}</th>
          <th>{{ 'app.dashboard.saleorder-item-amount' | translate }}</th>
          <th *ngIf="mode==='Add'">{{ 'app.operator' | translate }}</th>
        </tr>
      </thead>
      <tbody>
        <tr *ngFor="let item of saleOrderDto.items; let i = index">
          <td>
            <span *ngIf="editIndex!==i">{{item.number}}</span>
            <span *ngIf="editIndex===i" nz-form-control>
              <nz-input-group [nzAddOnAfter]="addOnAfterWarehouseNumberTemplate">
                <input nz-input #itemNumber="ngModel" [ngModel]="editObj.number" name="itemNumber" readonly="readonly"
                  reqiure placeholder="{{'app.dashboard.saleorder-please-item-number' | translate }}" />
              </nz-input-group>
              <nz-form-explain *ngIf="(itemNumber.dirty || itemNumber.touched) && itemNumber.errors?.required">
                {{ 'app.dashboard.saleorder-please-item-number' | translate }}
              </nz-form-explain>
              <ng-template #addOnAfterWarehouseNumberTemplate>
                <button nz-button nzType="primary" (click)="selectProductItem(i)" [disabled]="mode!=='Add'"
                  nzSize="small" nzGhost>{{ 'app.select' | translate }}</button>
              </ng-template>
            </span>
          </td>
          <td>
            <span *ngIf="editIndex!==i">{{item.name}}</span>
            <span *ngIf="editIndex===i" nz-form-control>
              <input nz-input #itemName="ngModel" [ngModel]="editObj.name" readonly="readonly" name="itemName" reqiure
                placeholder="{{'app.dashboard.saleorder-please-item-name' | translate }}">
              <nz-form-explain *ngIf="(itemName.dirty || itemName.touched) && itemName.errors?.required">
                {{ 'app.dashboard.saleorder-please-item-name' | translate }}
              </nz-form-explain>
            </span>
          </td>
          <td>
            <span *ngIf="editIndex!==i">{{item.price}}</span>
            <span *ngIf="editIndex===i" nz-form-control>
              <input nz-input #itemPrice="ngModel" [ngModel]="editObj.price" name="itemPrice" require
                placeholder="{{'app.dashboard.saleorder-please-item-price' | translate }}">
              <nz-form-explain *ngIf="(itemPrice.dirty || itemPrice.touched) && itemPrice.errors?.required">
                {{ 'app.dashboard.saleorder-please-item-price' | translate }}
              </nz-form-explain>
            </span>
          </td>
          <td>
            <span *ngIf="editIndex!==i">{{item.amount}}</span>
            <span *ngIf="editIndex===i" nz-form-control>
              <input nz-input #itemAmount="ngModel" [(ngModel)]="editObj.amount" name="itemAmount" require
                placeholder="{{'app.dashboard.saleorder-please-item-amount' | translate }}">
              <nz-form-explain *ngIf="(itemAmount.dirty || itemAmount.touched) && itemAmount.errors?.required">
                {{ 'app.dashboard.saleorder-please-item-amount' | translate }}
              </nz-form-explain>
            </span>
          </td>
          <td *ngIf="mode==='Add'">
            <span *ngIf="editIndex!==i">
              <a (click)="editItem(i)">{{ 'app.edit' | translate }}</a>
              <nz-divider nzType="vertical"></nz-divider>
              <nz-popconfirm (nzOnConfirm)="delItem(i)" nzTitle="{{ 'app.confirm-delete' | translate }}">
                <a nz-popconfirm>{{ 'app.delete' | translate }}</a>
              </nz-popconfirm>
            </span>
            <span *ngIf="editIndex===i">
              <a (click)="saveItem(i)">{{ 'app.save' | translate }}</a>
              <nz-divider nzType="vertical"></nz-divider>
              <nz-popconfirm (nzOnConfirm)="cancelItem(i)" nzTitle="{{ 'app.confirm-cancel' | translate }}">
                <a nz-popconfirm>{{ 'app.cancel' | translate }}</a>
              </nz-popconfirm>
            </span>
          </td>
        </tr>
      </tbody>
    </nz-table>
    <button *ngIf="editIndex===-1 && mode==='Add'" nz-button [nzType]="'dashed'" (click)="addItem()" nzBlock
      class="mt-md">
      <i nz-icon type="plus"></i>
      <span>{{ 'app.dashboard.add-saleorder-item' | translate }}</span>
    </button>
  </nz-card>
  <footer-toolbar errorCollect>
    <button nz-button nzType="default" [hidden]="mode=='Add' || !auth[mode]"
      (click)="startPrint()">{{ 'app.print' | translate }}</button>
    <button nz-button nzType="default" [hidden]="mode=='Add' || !auth[mode]"
      (click)="startExport()">{{ 'app.export' | translate }}</button>
    <button nz-button type="primary" nzType="primary"
      [disabled]="!auth[mode] && !f.valid && saleOrderDto.items.length<=0"
      (click)="submit()">{{ 'app.submit' | translate }}</button>
  </footer-toolbar>
</form>
